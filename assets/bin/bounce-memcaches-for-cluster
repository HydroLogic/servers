#!/usr/bin/env python

import boto
import sys
import os
import subprocess

TYPE='memcache'
COMMAND='sudo service memcached restart'

def get_servers(filters):

    conn = boto.connect_ec2()
    reservations = conn.get_all_instances(filters=filters)

    servers = list()

    for r in reservations:
        for i in r.instances:
           s = i.__dict__
           s['security_groups'] = map(lambda x: x.id, r.groups)
           servers.append(s)

    return servers

if __name__ == '__main__':

    if len(sys.argv) == 2:
        f = { 'tag:Cluster': os.getenv(sys.argv[1]) }
    elif os.getenv('CLUSTER'):
        f = { 'tag:Cluster': os.getenv('CLUSTER') }
    elif os.getenv('SECURITY_GROUP'):
        f = { 'group_id': os.getenv('SECURITY_GROUP') }
    else:
        print('%s CLUSTER_NAME' % sys.argv[0])
        exit()

    servers = get_servers(f.update({'tag:Type':TYPE, 
                          'instance-state-name':'running'}))

    for s in servers:
        command = "ssh -o \"StrictHostKeyChecking no\" -i $PRIVATE_KEY newsapps@%s '%s'" % (s['public_dns_name'],COMMAND)
        subprocess.call(command, shell=True)
